{% extends "base.html" %}

{% block title %}Indicadores de Calidad - MedCheck{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-primary">
                <i class="fas fa-chart-line"></i> Indicadores de Calidad en Tiempo Real
            </h1>
            <p class="lead">Análisis en tiempo real basado en datos de MedCheck</p>
            <hr>
        </div>
    </div>

    <!-- Selector de Período -->
    <div class="row mb-4">
        <div class="col-md-4">
            <label class="form-label"><i class="fas fa-calendar"></i> Período de Análisis</label>
            <select class="form-select" id="periodoSelect">
                <option value="7">Últimos 7 días</option>
                <option value="30" selected>Últimos 30 días</option>
                <option value="90">Últimos 90 días</option>
            </select>
        </div>
        <div class="col-md-8 d-flex align-items-end">
            <button class="btn btn-primary" onclick="cargarIndicadores()">
                <i class="fas fa-sync"></i> Actualizar Datos
            </button>
        </div>
    </div>

    <!-- Indicadores Principales (Cards) -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-warning" id="clmcCard">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="fas fa-tasks"></i> CLMC - Cumplimiento de Lista de Cotejo</h5>
                    <small>Indicador de Proceso</small>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="display-3 mb-0" id="clmcValor">
                                <span class="spinner-border" role="status"></span>
                            </h1>
                            <p class="text-muted mb-0">Meta: ≥ 90%</p>
                        </div>
                        <div class="text-end">
                            <p class="mb-0"><span id="clmcNumerador">-</span> / <span id="clmcDenominador">-</span></p>
                            <span class="badge" id="clmcNivel">Cargando...</span>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 20px;">
                        <div class="progress-bar" id="clmcProgress" role="progressbar" style="width: 0%">0%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card border-danger" id="teaemCard">
                <div class="card-header bg-danger text-white">
                    <h5><i class="fas fa-heartbeat"></i> TEAEM - Tasa de Eventos Adversos</h5>
                    <small>Indicador de Resultado</small>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="display-3 mb-0" id="teaemValor">
                                <span class="spinner-border" role="status"></span>
                            </h1>
                            <p class="text-muted mb-0">Meta: ≤ 2%</p>
                        </div>
                        <div class="text-end">
                            <p class="mb-0"><span id="teaemNumerador">-</span> / <span id="teaemDenominador">-</span></p>
                            <span class="badge" id="teaemNivel">Cargando...</span>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 20px;">
                        <div class="progress-bar" id="teaemProgress" role="progressbar" style="width: 0%">0%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico de Tendencia -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-chart-area"></i> Tendencia de Indicadores (Últimas 4 Semanas)</h5>
                </div>
                <div class="card-body">
                    <canvas id="tendenciaChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Cumplimiento por Correcto -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-pills"></i> Cumplimiento de Los 10 Correctos</h5>
                </div>
                <div class="card-body">
                    <canvas id="correctosChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla Detallada de Correctos -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5><i class="fas fa-table"></i> Detalle de Cumplimiento por Correcto</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped" id="correctosTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Correcto</th>
                                    <th>Cumplidos</th>
                                    <th>Total</th>
                                    <th>Porcentaje</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fichas Técnicas Flotantes (Interactivas) -->
    <div class="row mb-4">
        <!-- Ficha CLMC -->
        <div class="col-md-6">
            <div class="card shadow-sm border-warning ficha-tecnica">
                <div class="card-header bg-warning bg-gradient text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-calculator me-2"></i> 
                        Ficha Técnica CLMC
                    </h5>
                </div>
                <div class="card-body">
                    <h6 class="text-primary">Cumplimiento del Uso de la Lista de Cotejo Digital "MedCheck"</h6>
                    <hr>
                    
                    <div class="mb-3">
                        <strong><i class="fas fa-tag"></i> Tipo:</strong> 
                        <span class="badge bg-info">Indicador de Proceso - Positivo</span>
                    </div>
                    
                    <div class="mb-3">
                        <strong><i class="fas fa-function"></i> Fórmula:</strong>
                        <div class="formula-box p-2 bg-light rounded mt-2">
                            <code class="text-danger">CLMC (%) = (Formatos MedCheck Completos / Total de Administraciones) × 100</code>
                        </div>
                        <div class="mt-2 p-2 bg-primary bg-opacity-10 rounded">
                            <strong>Cálculo Actual:</strong>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <span>
                                    CLMC = (<span id="clmc_numerador_ficha">0</span> / <span id="clmc_denominador_ficha">0</span>) × 100
                                </span>
                                <span class="badge bg-primary" id="clmc_resultado_ficha">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong><i class="fas fa-bullseye"></i> Meta:</strong> 
                        <span class="text-success">≥ 90%</span> de cumplimiento mensual
                    </div>
                    
                    <div class="mb-2">
                        <strong><i class="fas fa-chart-bar"></i> Umbrales de Control:</strong>
                    </div>
                    <div class="umbrales-container">
                        <div class="umbral-item" id="clmc_umbral_optimo">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-circle text-success"></i> 90-100%: Calidad Óptima</span>
                                <span class="badge bg-success umbral-badge">Verde</span>
                            </div>
                            <div class="progress mt-1" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="umbral-item" id="clmc_umbral_alerta">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-circle text-warning"></i> 80-89%: Zona de Alerta</span>
                                <span class="badge bg-warning umbral-badge">Amarillo</span>
                            </div>
                            <div class="progress mt-1" style="height: 8px;">
                                <div class="progress-bar bg-warning" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="umbral-item" id="clmc_umbral_critico">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-circle text-danger"></i> &lt;80%: Fuera de Control</span>
                                <span class="badge bg-danger umbral-badge">Rojo</span>
                            </div>
                            <div class="progress mt-1" style="height: 8px;">
                                <div class="progress-bar bg-danger" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 p-2 border-start border-4 border-warning bg-light">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Interpretación:</strong> Este indicador mide qué porcentaje de administraciones 
                            de medicamentos tienen TODOS los 10 correctos completados correctamente.
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ficha TEAEM -->
        <div class="col-md-6">
            <div class="card shadow-sm border-danger ficha-tecnica">
                <div class="card-header bg-danger bg-gradient text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calculator me-2"></i> 
                        Ficha Técnica TEAEM
                    </h5>
                </div>
                <div class="card-body">
                    <h6 class="text-primary">Tasa de Eventos Adversos por Errores de Medicación</h6>
                    <hr>
                    
                    <div class="mb-3">
                        <strong><i class="fas fa-tag"></i> Tipo:</strong> 
                        <span class="badge bg-danger">Indicador de Resultado - Negativo</span>
                        <small class="text-muted">(menor es mejor)</small>
                    </div>
                    
                    <div class="mb-3">
                        <strong><i class="fas fa-function"></i> Fórmula:</strong>
                        <div class="formula-box p-2 bg-light rounded mt-2">
                            <code class="text-danger">TEAEM (%) = (Eventos con Incumplimiento ≥1 Correcto / Total de Administraciones) × 100</code>
                        </div>
                        <div class="mt-2 p-2 bg-danger bg-opacity-10 rounded">
                            <strong>Cálculo Actual:</strong>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <span>
                                    TEAEM = (<span id="teaem_numerador_ficha">0</span> / <span id="teaem_denominador_ficha">0</span>) × 100
                                </span>
                                <span class="badge bg-danger" id="teaem_resultado_ficha">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong><i class="fas fa-bullseye"></i> Meta:</strong> 
                        <span class="text-success">≤ 2%</span> de eventos adversos
                    </div>
                    
                    <div class="mb-2">
                        <strong><i class="fas fa-chart-bar"></i> Umbrales de Control:</strong>
                    </div>
                    <div class="umbrales-container">
                        <div class="umbral-item" id="teaem_umbral_excelencia">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-circle text-success"></i> 0-2%: Excelencia</span>
                                <span class="badge bg-success umbral-badge">Verde</span>
                            </div>
                            <div class="progress mt-1" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="umbral-item" id="teaem_umbral_vigilancia">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-circle text-warning"></i> 2.1-5%: Aceptable con Vigilancia</span>
                                <span class="badge bg-warning umbral-badge">Amarillo</span>
                            </div>
                            <div class="progress mt-1" style="height: 8px;">
                                <div class="progress-bar bg-warning" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="umbral-item" id="teaem_umbral_inaceptable">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-circle text-danger"></i> &gt;5%: Inaceptable</span>
                                <span class="badge bg-danger umbral-badge">Rojo</span>
                            </div>
                            <div class="progress mt-1" style="height: 8px;">
                                <div class="progress-bar bg-danger" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 p-2 border-start border-4 border-danger bg-light">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Interpretación:</strong> Este indicador mide qué porcentaje de administraciones 
                            tuvieron al menos UN correcto incumplido, representando potencial evento adverso.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .display-3 {
        font-weight: bold;
    }
    #correctosChart {
        max-height: 400px;
    }
    .ficha-tecnica {
        border-width: 2px;
    }
    .ficha-tecnica:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    .formula-box {
        border-left: 4px solid #0d6efd;
        font-size: 0.9rem;
    }
    .umbral-item {
        padding: 8px;
        margin: 6px 0;
        border-radius: 6px;
        background: #f8f9fa;
        transition: all 0.3s ease;
    }
    .umbral-item.activo {
        background: linear-gradient(135deg, #fff 0%, #e9ecef 100%);
        border: 2px solid;
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .umbral-item.activo .umbral-badge {
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    .umbral-item:not(.activo) {
        opacity: 0.6;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let tendenciaChart = null;
let correctosChart = null;

// Cargar indicadores al cargar la página
document.addEventListener('DOMContentLoaded', () => {
    cargarIndicadores();
});

// Recargar al cambiar período
document.getElementById('periodoSelect').addEventListener('change', () => {
    cargarIndicadores();
});

async function cargarIndicadores() {
    const dias = document.getElementById('periodoSelect').value;
    
    try {
        // Cargar datos en paralelo
        const [resumenData, tendenciaData] = await Promise.all([
            fetch(`/api/indicadores/resumen?dias=${dias}`).then(r => r.json()),
            fetch(`/api/indicadores/tendencia?semanas=4`).then(r => r.json())
        ]);
        
        // Actualizar CLMC
        actualizarCLMC(resumenData.clmc);
        
        // Actualizar TEAEM
        actualizarTEAEM(resumenData.teaem);
        
        // Actualizar gráfico de tendencia
        actualizarTendencia(tendenciaData);
        
        // Actualizar cumplimiento por correcto
        actualizarCorrectos(resumenData.por_correcto);
        
    } catch (error) {
        console.error('Error cargando indicadores:', error);
        alert('Error al cargar los indicadores. Verifica que hay datos en la base de datos.');
    }
}

function actualizarCLMC(data) {
    // Actualizar card principal
    document.getElementById('clmcValor').textContent = data.valor.toFixed(1) + '%';
    document.getElementById('clmcNumerador').textContent = data.numerador;
    document.getElementById('clmcDenominador').textContent = data.denominador;
    
    const nivel = document.getElementById('clmcNivel');
    nivel.textContent = data.nivel;
    nivel.className = `badge bg-${data.color}`;
    
    const progress = document.getElementById('clmcProgress');
    progress.style.width = data.valor + '%';
    progress.className = `progress-bar bg-${data.color}`;
    progress.textContent = data.valor.toFixed(1) + '%';
    
    // Actualizar ficha técnica
    document.getElementById('clmc_numerador_ficha').textContent = data.numerador;
    document.getElementById('clmc_denominador_ficha').textContent = data.denominador;
    document.getElementById('clmc_resultado_ficha').textContent = data.valor.toFixed(1) + '%';
    document.getElementById('clmc_resultado_ficha').className = `badge bg-${data.color}`;
    
    // Resaltar umbral activo
    document.querySelectorAll('[id^="clmc_umbral_"]').forEach(el => el.classList.remove('activo'));
    if (data.valor >= 90) {
        document.getElementById('clmc_umbral_optimo').classList.add('activo');
        document.getElementById('clmc_umbral_optimo').style.borderColor = '#198754';
    } else if (data.valor >= 80) {
        document.getElementById('clmc_umbral_alerta').classList.add('activo');
        document.getElementById('clmc_umbral_alerta').style.borderColor = '#ffc107';
    } else {
        document.getElementById('clmc_umbral_critico').classList.add('activo');
        document.getElementById('clmc_umbral_critico').style.borderColor = '#dc3545';
    }
}

function actualizarTEAEM(data) {
    // Actualizar card principal
    document.getElementById('teaemValor').textContent = data.valor.toFixed(1) + '%';
    document.getElementById('teaemNumerador').textContent = data.numerador;
    document.getElementById('teaemDenominador').textContent = data.denominador;
    
    const nivel = document.getElementById('teaemNivel');
    nivel.textContent = data.nivel;
    nivel.className = `badge bg-${data.color}`;
    
    const progress = document.getElementById('teaemProgress');
    progress.style.width = data.valor + '%';
    progress.className = `progress-bar bg-${data.color}`;
    progress.textContent = data.valor.toFixed(1) + '%';
    
    // Actualizar ficha técnica
    document.getElementById('teaem_numerador_ficha').textContent = data.numerador;
    document.getElementById('teaem_denominador_ficha').textContent = data.denominador;
    document.getElementById('teaem_resultado_ficha').textContent = data.valor.toFixed(1) + '%';
    document.getElementById('teaem_resultado_ficha').className = `badge bg-${data.color}`;
    
    // Resaltar umbral activo (para TEAEM menor es mejor)
    document.querySelectorAll('[id^="teaem_umbral_"]').forEach(el => el.classList.remove('activo'));
    if (data.valor <= 2) {
        document.getElementById('teaem_umbral_excelencia').classList.add('activo');
        document.getElementById('teaem_umbral_excelencia').style.borderColor = '#198754';
    } else if (data.valor <= 5) {
        document.getElementById('teaem_umbral_vigilancia').classList.add('activo');
        document.getElementById('teaem_umbral_vigilancia').style.borderColor = '#ffc107';
    } else {
        document.getElementById('teaem_umbral_inaceptable').classList.add('activo');
        document.getElementById('teaem_umbral_inaceptable').style.borderColor = '#dc3545';
    }
}

function actualizarTendencia(data) {
    const ctx = document.getElementById('tendenciaChart').getContext('2d');
    
    if (tendenciaChart) {
        tendenciaChart.destroy();
    }
    
    tendenciaChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.semanas,
            datasets: [
                {
                    label: 'CLMC (%)',
                    data: data.clmc,
                    borderColor: 'rgb(255, 193, 7)',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'TEAEM (%)',
                    data: data.teaem,
                    borderColor: 'rgb(220, 53, 69)',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Porcentaje (%)'
                    }
                }
            }
        }
    });
}

function actualizarCorrectos(data) {
    const ctx = document.getElementById('correctosChart').getContext('2d');
    
    if (correctosChart) {
        correctosChart.destroy();
    }
    
    const nombres = data.map(d => d.nombre);
    const porcentajes = data.map(d => d.porcentaje);
    const colores = porcentajes.map(p => {
        if (p >= 90) return 'rgba(25, 135, 84, 0.8)';
        if (p >= 80) return 'rgba(255, 193, 7, 0.8)';
        return 'rgba(220, 53, 69, 0.8)';
    });
    
    correctosChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: nombres,
            datasets: [{
                label: 'Cumplimiento (%)',
                data: porcentajes,
                backgroundColor: colores,
                borderColor: colores.map(c => c.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Porcentaje de Cumplimiento (%)'
                    }
                }
            }
        }
    });
    
    // Actualizar tabla
    const tbody = document.querySelector('#correctosTable tbody');
    tbody.innerHTML = data.map(item => `
        <tr>
            <td><strong>${item.nombre}</strong></td>
            <td>${item.cumplidos}</td>
            <td>${item.total}</td>
            <td>${item.porcentaje.toFixed(1)}%</td>
            <td>
                <span class="badge bg-${item.porcentaje >= 90 ? 'success' : item.porcentaje >= 80 ? 'warning' : 'danger'}">
                    ${item.porcentaje >= 90 ? 'Óptimo' : item.porcentaje >= 80 ? 'Aceptable' : 'Requiere Atención'}
                </span>
            </td>
        </tr>
    `).join('');
}
</script>
{% endblock %}
