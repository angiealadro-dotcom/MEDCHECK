{% extends "base.html" %}

{% block title %}Dashboard de Reportes{% endblock %}

{% block head_extras %}
<style>
.recommendations-panel {
    position: sticky;
    top: 20px;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
}
.recommendation-card {
    border-left: 4px solid;
    margin-bottom: 1rem;
}
.recommendation-card.critico {
    border-left-color: #dc3545;
    background: #fff5f5;
}
.recommendation-card.advertencia {
    border-left-color: #ffc107;
    background: #fffef5;
}
.recommendation-card.exito {
    border-left-color: #28a745;
    background: #f5fff7;
}
.recommendation-card.info {
    border-left-color: var(--brand-lavender);
    background: #f9f7ff;
}
.voice-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--brand-navy), var(--brand-lavender));
    border: none;
    color: white;
    font-size: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1000;
    transition: transform 0.2s;
}
.voice-btn:hover {
    transform: scale(1.1);
}
.voice-btn.playing {
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-9">
        <h2>Dashboard de Reportes</h2>
        
        <!-- Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    {% if current_user and current_user.role == "admin" %}
                    <div class="col-md-4">
                        <label class="form-label">Área</label>
                        <select class="form-select" name="area">
                            <option value="">Todas las áreas</option>
                            {% for area_option in areas_disponibles %}
                            <option value="{{ area_option }}" {% if area_filtrada == area_option %}selected{% endif %}>{{ area_option }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div class="col-md-4">
                        <label class="form-label">Periodo</label>
                        <select class="form-select" name="periodo">
                            <option value="7d" {% if periodo == "7d" %}selected{% endif %}>Últimos 7 días</option>
                            <option value="30d" {% if periodo == "30d" %}selected{% endif %}>Últimos 30 días</option>
                            <option value="90d" {% if periodo == "90d" %}selected{% endif %}>Últimos 90 días</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end justify-content-between">
                        <button type="submit" class="btn btn-primary">Actualizar</button>
                        <div class="btn-group">
                            <button type="button" id="exportPdf" class="btn btn-outline-secondary">Exportar PDF</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Resumen -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white" style="background: linear-gradient(135deg, var(--brand-navy), #1b2a85);">
                    <div class="card-body">
                        <h5 class="card-title">Total Items</h5>
                        <h2>{{ summary.total_items if summary else 0 }}</h2>
                        <small>{{ summary.periodo_desde if summary }} - {{ summary.periodo_hasta if summary }}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card {% if summary and summary.porcentaje_cumplimiento >= 90 %}bg-success{% elif summary and summary.porcentaje_cumplimiento >= 70 %}bg-warning{% else %}bg-danger{% endif %} text-white">
                    <div class="card-body">
                        <h5 class="card-title">Cumplimiento General</h5>
                        <h2>{{ summary.porcentaje_cumplimiento if summary else 0 }}%</h2>
                        <small>Meta: 95%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Items Cumplidos</h5>
                        <h2>{{ summary.items_cumplidos if summary else 0 }}</h2>
                        <small>de {{ summary.total_items if summary else 0 }}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white" style="background: linear-gradient(135deg, var(--brand-lavender), #c5a8f0);">
                    <div class="card-body">
                        <h5 class="card-title">Periodo</h5>
                        <h2>{{ periodo }}</h2>
                        <small>Filtro activo</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cumplimiento por Etapa -->
        {% if summary and summary.cumplimiento_por_etapa %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Detalle por Etapa del Protocolo</h5>
                        <div class="row">
                            {% for etapa, datos in summary.cumplimiento_por_etapa.items() %}
                            <div class="col-md-4">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <strong>{{ etapa|capitalize }}</strong>
                                    </div>
                                    <div class="card-body">
                                        <h3 class="{% if datos.porcentaje >= 90 %}text-success{% elif datos.porcentaje >= 70 %}text-warning{% else %}text-danger{% endif %}">
                                            {{ datos.porcentaje }}%
                                        </h3>
                                        <p class="mb-0">{{ datos.cumplidos }} de {{ datos.total }} items</p>
                                        <div class="progress mt-2">
                                            <div class="progress-bar {% if datos.porcentaje >= 90 %}bg-success{% elif datos.porcentaje >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {{ datos.porcentaje }}%">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Gráficos -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Cumplimiento por Etapa</h5>
                        <canvas id="cumplimientoChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Distribución General</h5>
                        <canvas id="areasPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Últimas Entradas -->
        {% if entries %}
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Últimas 50 Verificaciones</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Área</th>
                                        <th>Turno</th>
                                        <th>Etapa</th>
                                        <th>Item</th>
                                        <th>Estado</th>
                                        <th>Usuario</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in entries[:50] %}
                                    <tr>
                                        <td>{{ entry.fecha_hora.strftime('%Y-%m-%d %H:%M') if entry.fecha_hora else 'N/A' }}</td>
                                        <td>{{ entry.area }}</td>
                                        <td><span class="badge" style="background: var(--brand-navy);">{{ entry.turno }}</span></td>
                                        <td>{{ entry.protocolo_etapa }}</td>
                                        <td>{{ entry.item }}</td>
                                        <td>
                                            {% if entry.cumple %}
                                            <span class="badge bg-success">✓ Cumple</span>
                                            {% else %}
                                            <span class="badge bg-danger">✗ No cumple</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ entry.usuario }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <strong>No hay datos disponibles</strong> para el periodo seleccionado.
        </div>
        {% endif %}
    </div><!-- fin col-md-9 -->
    
    <!-- Panel de Recomendaciones -->
    <div class="col-md-3">
        <div class="recommendations-panel">
            <h5 class="mb-3"><i class="fas fa-lightbulb"></i> Recomendaciones</h5>
            <div id="recommendationsContainer">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Botón flotante de voz (si no hay clave se mostrará igualmente con guía) -->
<button id="voiceBtn" class="voice-btn" title="Escuchar resumen del reporte">
    <i class="fas fa-volume-up"></i>
</button>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const cumplimientoCtx = document.getElementById('cumplimientoChart');
    const areasPieCtx = document.getElementById('areasPieChart');
    
    // Datos del servidor
    const summary = {{ summary|tojson if summary else '{}' }};
    const cumplimientoPorEtapa = summary.cumplimiento_por_etapa || {};
    
    // Gráfico de cumplimiento por etapa
    const etapas = ['prescripción', 'preparación', 'administración'];
    const cumplimientoData = etapas.map(etapa => 
        cumplimientoPorEtapa[etapa] ? cumplimientoPorEtapa[etapa].porcentaje : 0
    );
    
    new Chart(cumplimientoCtx, {
        type: 'bar',
        data: {
            labels: ['Prescripción', 'Preparación', 'Administración'],
            datasets: [{
                label: '% Cumplimiento por Etapa',
                data: cumplimientoData,
                backgroundColor: [
                    'rgba(15, 26, 86, 0.7)',
                    'rgba(168, 139, 222, 0.7)',
                    'rgba(189, 248, 255, 0.7)'
                ],
                borderColor: [
                    'rgb(15, 26, 86)',
                    'rgb(168, 139, 222)',
                    'rgb(189, 248, 255)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Gráfico de pie (general vs no cumplido)
    const cumplidos = summary.items_cumplidos || 0;
    const noCumplidos = (summary.total_items || 0) - cumplidos;
    
    new Chart(areasPieCtx, {
        type: 'doughnut',
        data: {
            labels: ['Cumplidos', 'No Cumplidos'],
            datasets: [{
                data: [cumplidos, noCumplidos],
                backgroundColor: [
                    'rgba(168, 139, 222, 0.85)',
                    'rgba(255, 99, 132, 0.85)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
    
    // Manejar envío del formulario de filtros
    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(filterForm);
            const params = new URLSearchParams(formData);
            window.location.href = `/reports/dashboard?${params.toString()}`;
        });
    }

    // Exportar PDF respetando filtros (área y periodo)
    const exportBtn = document.getElementById('exportPdf');
    if (exportBtn && filterForm) {
        exportBtn.addEventListener('click', () => {
            const formData = new FormData(filterForm);
            const area = formData.get('area') || '';
            const periodo = formData.get('periodo') || '30d';
            // Calcular desde/hasta en frontend
            const now = new Date();
            let days = 30;
            if (periodo === '7d') days = 7; else if (periodo === '90d') days = 90;
            const desde = new Date(now.getTime() - days*24*60*60*1000);
            const toISO = d => d.toISOString();
            const params = new URLSearchParams();
            if (area) params.set('area', area);
            params.set('desde', toISO(desde));
            params.set('hasta', toISO(now));
            window.location.href = `/reports/export/pdf?${params.toString()}`;
        });
    }

    // ===== CARGAR RECOMENDACIONES Y ACTIVAR VOZ =====
    async function loadRecommendations() {
        const filterForm = document.getElementById('filterForm');
        if (!filterForm) return;
        
        const formData = new FormData(filterForm);
        const periodo = formData.get('periodo') || '7d';
        const area = formData.get('area') || '';
        
        const container = document.getElementById('recommendationsContainer');
        
        try {
            const res = await fetch(`/reports/recommendations?periodo=${periodo}&area=${area}`);
            if (!res.ok) throw new Error('Error al cargar recomendaciones');
            
            const data = await res.json();
            renderRecommendations(data.recomendaciones || []);
        } catch (error) {
            console.error('Error loading recommendations:', error);
            container.innerHTML = `
                <div class="alert alert-warning p-2">
                    <i class="fas fa-exclamation-triangle"></i>
                    <small>No se pudieron cargar las recomendaciones</small>
                </div>
            `;
        }
    }

    function renderRecommendations(recommendations) {
        const container = document.getElementById('recommendationsContainer');
        
        if (recommendations.length === 0) {
            container.innerHTML = `
                <div class="alert alert-success p-3">
                    <i class="fas fa-check-circle mb-2"></i>
                    <p class="mb-0"><strong>¡Excelente trabajo!</strong></p>
                    <small>No hay recomendaciones críticas en este momento.</small>
                </div>
            `;
            return;
        }
        
        container.innerHTML = recommendations.map(rec => `
            <div class="card recommendation-card ${rec.tipo} p-3 mb-2">
                <div class="d-flex align-items-start">
                    <i class="fas ${rec.icono} me-2 mt-1" style="font-size: 1.2rem;"></i>
                    <div class="flex-grow-1">
                        <strong class="d-block mb-1">${rec.titulo}</strong>
                        <small class="text-muted">${rec.descripcion}</small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Activar botón de voz
    const voiceBtn = document.getElementById('voiceBtn');
    let voiceAvailable = false;

    // Verificar disponibilidad de clave en el servidor
    fetch('/reports/voice-status').then(r => r.json()).then(j => {
        voiceAvailable = !!(j && j.enabled);
        if (!voiceAvailable) {
            voiceBtn.title = 'Configura ELEVENLABS_API_KEY en Render > Environment para habilitar voz';
        }
    }).catch(() => {
        // Si el endpoint no existe, dejamos el comportamiento por defecto
    });

    if (voiceBtn) {
        voiceBtn.addEventListener('click', async function() {
            if (!voiceAvailable) {
                alert('Para habilitar la voz, configura ELEVENLABS_API_KEY en Render > Environment y redepliega.');
                return;
            }
            const filterForm = document.getElementById('filterForm');
            if (!filterForm) return;
            
            const formData = new FormData(filterForm);
            const periodo = formData.get('periodo') || '7d';
            const area = formData.get('area') || '';
            
            const icon = voiceBtn.querySelector('i');
            const originalClass = icon.className;
            
            try {
                icon.className = 'fas fa-spinner fa-spin';
                voiceBtn.disabled = true;
                
                const audio = new Audio(`/reports/voice-summary?periodo=${periodo}&area=${area}`);
                
                audio.onloadstart = () => {
                    icon.className = 'fas fa-volume-up';
                    voiceBtn.classList.add('playing');
                };
                
                audio.onended = () => {
                    icon.className = originalClass;
                    voiceBtn.classList.remove('playing');
                    voiceBtn.disabled = false;
                };
                
                audio.onerror = () => {
                    throw new Error('Error al reproducir audio');
                };
                
                await audio.play();
                
            } catch (error) {
                console.error('Voice error:', error);
                icon.className = originalClass;
                voiceBtn.classList.remove('playing');
                voiceBtn.disabled = false;
                
                alert('⚠️ Servicio de voz no disponible.\n\nAsegúrate de que ELEVENLABS_API_KEY esté configurado en Render > Environment y que tu clave tenga el permiso "text_to_speech".');
            }
        });
    }

    // Cargar recomendaciones al inicio
    loadRecommendations();
});
</script>
{% endblock %}
