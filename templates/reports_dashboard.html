{% extends "base.html" %}

{% block title %}Dashboard de Reportes{% endblock %}

{% block head_extras %}
<style>
.recommendations-panel {
    position: sticky;
    top: 20px;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
}
.recommendation-card {
    border-left: 4px solid;
    margin-bottom: 1rem;
}
.recommendation-card.critico {
    border-left-color: #dc3545;
    background: #fff5f5;
}
.recommendation-card.advertencia {
    border-left-color: #ffc107;
    background: #fffef5;
}
.recommendation-card.exito {
    border-left-color: #28a745;
    background: #f5fff7;
}
.recommendation-card.info {
    border-left-color: var(--brand-lavender);
    background: #f9f7ff;
}
.voice-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--brand-navy), var(--brand-lavender));
    border: none;
    color: white;
    font-size: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1000;
    transition: transform 0.2s;
}
.voice-btn:hover {
    transform: scale(1.1);
}
.voice-btn.playing {
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* Risk Matrix Styles */
.risk-matrix-container {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
}

.risk-matrix {
    display: flex;
    gap: 10px;
    max-width: 100%;
    overflow-x: auto;
}

.risk-axis-y {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.axis-label {
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    text-align: center;
    font-weight: 600;
    color: #495057;
    padding: 10px 5px;
    font-size: 0.9rem;
}

.axis-values {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.axis-value {
    width: 100px;
    height: 70px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    font-weight: 600;
    color: #495057;
    font-size: 1.1rem;
}

.axis-value small {
    font-size: 0.7rem;
    font-weight: 400;
    color: #6c757d;
}

.risk-grid-container {
    flex: 1;
}

.risk-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    grid-template-rows: repeat(5, 1fr);
    gap: 5px;
    margin-bottom: 10px;
}

.risk-cell {
    aspect-ratio: 1;
    min-height: 70px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.risk-cell::after {
    content: attr(data-score);
    font-size: 1.5rem;
    font-weight: 700;
    opacity: 0.3;
}

.risk-cell:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    z-index: 10;
}

.risk-cell.active {
    box-shadow: 0 0 0 3px #fff, 0 0 0 6px #0d6efd;
    transform: scale(1.05);
}

.risk-low {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
}

.risk-medium {
    background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%);
    color: #000;
}

.risk-high {
    background: linear-gradient(135deg, #fd7e14 0%, #ff8534 100%);
    color: white;
}

.risk-critical {
    background: linear-gradient(135deg, #dc3545 0%, #e35d6a 100%);
    color: white;
}

.risk-axis-x {
    margin-top: 10px;
}

.axis-values-x {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 5px;
}

.axis-value-x {
    text-align: center;
    font-weight: 600;
    color: #495057;
    padding: 10px 5px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    font-size: 1rem;
}

.axis-value-x small {
    font-size: 0.7rem;
    font-weight: 400;
    color: #6c757d;
    display: block;
    margin-top: 2px;
}

.axis-label-x {
    text-align: center;
    font-weight: 600;
    color: #495057;
    margin-top: 10px;
    font-size: 0.9rem;
}

.risk-legend {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    padding: 15px;
    background: white;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
}

.legend-color {
    width: 30px;
    height: 30px;
    border-radius: 5px;
    flex-shrink: 0;
}

.legend-text {
    font-size: 0.85rem;
    line-height: 1.3;
}

.risk-info-panel {
    margin-top: 20px;
}

.risk-badge {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    margin: 5px;
}

/* Responsive */
@media (max-width: 768px) {
    .risk-matrix {
        flex-direction: column;
    }
    .axis-label {
        writing-mode: horizontal-tb;
        transform: none;
    }
    .axis-value {
        width: auto;
        height: auto;
        padding: 10px;
    }
    .risk-cell {
        min-height: 60px;
    }
    .risk-legend {
        grid-template-columns: 1fr;
    }
}

</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-9">
        <h2>Dashboard de Reportes</h2>

        <!-- Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    {% if current_user and current_user.role == "admin" %}
                    <div class="col-md-4">
                        <label class="form-label">√Årea</label>
                        <select class="form-select" name="area">
                            <option value="">Todas las √°reas</option>
                            {% for area_option in areas_disponibles %}
                            <option value="{{ area_option }}" {% if area_filtrada == area_option %}selected{% endif %}>{{ area_option }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div class="col-md-4">
                        <label class="form-label">Periodo</label>
                        <select class="form-select" name="periodo">
                            <option value="7d" {% if periodo == "7d" %}selected{% endif %}>√öltimos 7 d√≠as</option>
                            <option value="30d" {% if periodo == "30d" %}selected{% endif %}>√öltimos 30 d√≠as</option>
                            <option value="90d" {% if periodo == "90d" %}selected{% endif %}>√öltimos 90 d√≠as</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end justify-content-between">
                        <button type="submit" class="btn btn-primary">Actualizar</button>
                        <div class="btn-group">
                            <button type="button" id="exportPdf" class="btn btn-outline-secondary">Exportar PDF</button>
                            <button type="button" id="testPush" class="btn btn-outline-success" title="Enviar notificaci√≥n de prueba">
                                <i class="fas fa-bell"></i>
                            </button>
                            <button type="button" id="testLocalNotif" class="btn btn-outline-info" title="Mostrar notificaci√≥n local (sin push)">
                                <i class="fas fa-bell-slash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-12 mt-2 d-flex align-items-center gap-2">
                        <div class="input-group input-group-sm" style="max-width: 260px;">
                            <span class="input-group-text">Recordatorio en</span>
                            <input type="number" id="quickMinutes" class="form-control" min="1" value="1" style="max-width: 80px;"/>
                            <span class="input-group-text">min</span>
                        </div>
                        <button type="button" id="scheduleQuick" class="btn btn-sm btn-outline-primary" title="Programar recordatorio r√°pido">
                            <i class="fas fa-hourglass-start"></i> Programar
                        </button>
                        </div>
                </form>
            </div>
        </div>

        <!-- Resumen -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white" style="background: linear-gradient(135deg, var(--brand-navy), #1b2a85);">
                    <div class="card-body">
                        <h5 class="card-title">Total Items</h5>
                        <h2>{{ summary.total_items if summary else 0 }}</h2>
                        <small>{{ summary.periodo_desde if summary }} - {{ summary.periodo_hasta if summary }}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card {% if summary and summary.porcentaje_cumplimiento >= 90 %}bg-success{% elif summary and summary.porcentaje_cumplimiento >= 70 %}bg-warning{% else %}bg-danger{% endif %} text-white">
                    <div class="card-body">
                        <h5 class="card-title">Cumplimiento General</h5>
                        <h2>{{ summary.porcentaje_cumplimiento if summary else 0 }}%</h2>
                        <small>Meta: 95%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Items Cumplidos</h5>
                        <h2>{{ summary.items_cumplidos if summary else 0 }}</h2>
                        <small>de {{ summary.total_items if summary else 0 }}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white" style="background: linear-gradient(135deg, var(--brand-lavender), #c5a8f0);">
                    <div class="card-body">
                        <h5 class="card-title">Periodo</h5>
                        <h2>{{ periodo }}</h2>
                        <small>Filtro activo</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cumplimiento por Etapa -->
        {% if summary and summary.cumplimiento_por_etapa %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Detalle por Etapa del Protocolo</h5>
                        <div class="row">
                            {% for etapa, datos in summary.cumplimiento_por_etapa.items() %}
                            <div class="col-md-4">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <strong>{{ etapa|capitalize }}</strong>
                                    </div>
                                    <div class="card-body">
                                        <h3 class="{% if datos.porcentaje >= 90 %}text-success{% elif datos.porcentaje >= 70 %}text-warning{% else %}text-danger{% endif %}">
                                            {{ datos.porcentaje }}%
                                        </h3>
                                        <p class="mb-0">{{ datos.cumplidos }} de {{ datos.total }} items</p>
                                        <div class="progress mt-2">
                                            <div class="progress-bar {% if datos.porcentaje >= 90 %}bg-success{% elif datos.porcentaje >= 70 %}bg-warning{% else %}bg-danger{% endif %}"
                                                 role="progressbar"
                                                 style="width: {{ datos.porcentaje }}%">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Matriz de Riesgos Interactiva -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-th me-2"></i>
                                Matriz de Riesgos - Toma de Decisiones
                            </h5>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary active" data-view="matrix">
                                    <i class="fas fa-th"></i> Matriz
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-view="list">
                                    <i class="fas fa-list"></i> Lista
                                </button>
                            </div>
                        </div>

                        <!-- Vista de Matriz -->
                        <div id="matrixView">
                            <div class="risk-matrix-container mb-3">
                                <div class="risk-matrix">
                                    <!-- Eje Y: Probabilidad -->
                                    <div class="risk-axis-y">
                                        <div class="axis-label">Probabilidad/<br>Nivel de Riesgo</div>
                                        <div class="axis-values">
                                            <div class="axis-value">5<br><small>Muy probable</small></div>
                                            <div class="axis-value">4<br><small>Probable</small></div>
                                            <div class="axis-value">3<br><small>Posible</small></div>
                                            <div class="axis-value">2<br><small>Poco probable</small></div>
                                            <div class="axis-value">1<br><small>Muy improbable</small></div>
                                        </div>
                                    </div>

                                    <!-- Grid de la matriz -->
                                    <div class="risk-grid-container">
                                        <div class="risk-grid" id="riskGrid">
                                            <!-- Fila 5 (Muy probable) -->
                                            <div class="risk-cell risk-medium" data-prob="5" data-impact="1" data-score="5"></div>
                                            <div class="risk-cell risk-high" data-prob="5" data-impact="2" data-score="10"></div>
                                            <div class="risk-cell risk-high" data-prob="5" data-impact="3" data-score="15"></div>
                                            <div class="risk-cell risk-critical" data-prob="5" data-impact="4" data-score="20"></div>
                                            <div class="risk-cell risk-critical" data-prob="5" data-impact="5" data-score="25"></div>

                                            <!-- Fila 4 (Probable) -->
                                            <div class="risk-cell risk-low" data-prob="4" data-impact="1" data-score="4"></div>
                                            <div class="risk-cell risk-medium" data-prob="4" data-impact="2" data-score="8"></div>
                                            <div class="risk-cell risk-medium" data-prob="4" data-impact="3" data-score="12"></div>
                                            <div class="risk-cell risk-high" data-prob="4" data-impact="4" data-score="16"></div>
                                            <div class="risk-cell risk-critical" data-prob="4" data-impact="5" data-score="20"></div>

                                            <!-- Fila 3 (Posible) -->
                                            <div class="risk-cell risk-low" data-prob="3" data-impact="1" data-score="3"></div>
                                            <div class="risk-cell risk-low" data-prob="3" data-impact="2" data-score="6"></div>
                                            <div class="risk-cell risk-medium" data-prob="3" data-impact="3" data-score="9"></div>
                                            <div class="risk-cell risk-medium" data-prob="3" data-impact="4" data-score="12"></div>
                                            <div class="risk-cell risk-high" data-prob="3" data-impact="5" data-score="15"></div>

                                            <!-- Fila 2 (Poco probable) -->
                                            <div class="risk-cell risk-low" data-prob="2" data-impact="1" data-score="2"></div>
                                            <div class="risk-cell risk-low" data-prob="2" data-impact="2" data-score="4"></div>
                                            <div class="risk-cell risk-low" data-prob="2" data-impact="3" data-score="6"></div>
                                            <div class="risk-cell risk-medium" data-prob="2" data-impact="4" data-score="8"></div>
                                            <div class="risk-cell risk-medium" data-prob="2" data-impact="5" data-score="10"></div>

                                            <!-- Fila 1 (Muy improbable) -->
                                            <div class="risk-cell risk-low" data-prob="1" data-impact="1" data-score="1"></div>
                                            <div class="risk-cell risk-low" data-prob="1" data-impact="2" data-score="2"></div>
                                            <div class="risk-cell risk-low" data-prob="1" data-impact="3" data-score="3"></div>
                                            <div class="risk-cell risk-low" data-prob="1" data-impact="4" data-score="4"></div>
                                            <div class="risk-cell risk-low" data-prob="1" data-impact="5" data-score="5"></div>
                                        </div>

                                        <!-- Eje X: Impacto -->
                                        <div class="risk-axis-x">
                                            <div class="axis-values-x">
                                                <div class="axis-value-x">1<br><small>Insignificante</small></div>
                                                <div class="axis-value-x">2<br><small>Menor</small></div>
                                                <div class="axis-value-x">3<br><small>Moderado</small></div>
                                                <div class="axis-value-x">4<br><small>Importante</small></div>
                                                <div class="axis-value-x">5<br><small>Catastr√≥fico</small></div>
                                            </div>
                                            <div class="axis-label-x">Impacto</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Leyenda -->
                            <div class="risk-legend mb-3">
                                <div class="legend-item">
                                    <span class="legend-color risk-low"></span>
                                    <span class="legend-text"><strong>Bajo (1-6):</strong> Aceptable - Monitoreo rutinario</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color risk-medium"></span>
                                    <span class="legend-text"><strong>Medio (8-12):</strong> Tolerable - Plan de mitigaci√≥n</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color risk-high"></span>
                                    <span class="legend-text"><strong>Alto (15-16):</strong> Inaceptable - Acci√≥n inmediata</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color risk-critical"></span>
                                    <span class="legend-text"><strong>Cr√≠tico (20-25):</strong> Emergencia - Intervenci√≥n urgente</span>
                                </div>
                            </div>

                            <!-- Panel de informaci√≥n -->
                            <div class="risk-info-panel" id="riskInfoPanel" style="display: none;">
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <span id="riskTitle">Seleccione una celda</span>
                                    </h6>
                                    <div id="riskDetails">
                                        Haga clic en una celda de la matriz para ver los riesgos identificados y las acciones recomendadas.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vista de Lista -->
                        <div id="listView" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Riesgo</th>
                                            <th>Probabilidad</th>
                                            <th>Impacto</th>
                                            <th>Nivel</th>
                                            <th>Acci√≥n Recomendada</th>
                                        </tr>
                                    </thead>
                                    <tbody id="riskListBody">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                Cargando riesgos identificados...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°fico de Distribuci√≥n -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Distribuci√≥n de Riesgos</h5>
                        <canvas id="riskDistributionChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Distribuci√≥n por √Årea</h5>
                        <canvas id="areasPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- √öltimas Entradas -->
        {% if entries %}
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>√öltimas 50 Verificaciones</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>√Årea</th>
                                        <th>Turno</th>
                                        <th>Etapa</th>
                                        <th>Item</th>
                                        <th>Estado</th>
                                        <th>Usuario</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in entries[:50] %}
                                    <tr>
                                        <td>{{ entry.fecha_hora.strftime('%Y-%m-%d %H:%M') if entry.fecha_hora else 'N/A' }}</td>
                                        <td>{{ entry.area }}</td>
                                        <td><span class="badge" style="background: var(--brand-navy);">{{ entry.turno }}</span></td>
                                        <td>{{ entry.protocolo_etapa }}</td>
                                        <td>{{ entry.item }}</td>
                                        <td>
                                            {% if entry.cumple %}
                                            <span class="badge bg-success">‚úì Cumple</span>
                                            {% else %}
                                            <span class="badge bg-danger">‚úó No cumple</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ entry.usuario }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <strong>No hay datos disponibles</strong> para el periodo seleccionado.
        </div>
        {% endif %}
    </div><!-- fin col-md-9 -->

    <!-- Panel de Recomendaciones -->
    <div class="col-md-3">
        <div class="recommendations-panel">
            <h5 class="mb-3"><i class="fas fa-lightbulb"></i> Recomendaciones</h5>
            <div id="recommendationsContainer">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bot√≥n flotante de voz (si no hay clave se mostrar√° igualmente con gu√≠a) -->
<button id="voiceBtn" class="voice-btn" title="Escuchar resumen del reporte">
    <i class="fas fa-volume-up"></i>
</button>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const cumplimientoCtx = document.getElementById('cumplimientoChart');
    const areasPieCtx = document.getElementById('areasPieChart');

    // Datos del servidor
    const summary = {{ summary|tojson if summary else '{}' }};
    const cumplimientoPorEtapa = summary.cumplimiento_por_etapa || {};

    // Gr√°fico de cumplimiento por etapa
    const etapas = ['prescripci√≥n', 'preparaci√≥n', 'administraci√≥n'];
    const cumplimientoData = etapas.map(etapa =>
        cumplimientoPorEtapa[etapa] ? cumplimientoPorEtapa[etapa].porcentaje : 0
    );

    new Chart(cumplimientoCtx, {
        type: 'bar',
        data: {
            labels: ['Prescripci√≥n', 'Preparaci√≥n', 'Administraci√≥n'],
            datasets: [{
                label: '% Cumplimiento por Etapa',
                data: cumplimientoData,
                backgroundColor: [
                    'rgba(15, 26, 86, 0.7)',
                    'rgba(168, 139, 222, 0.7)',
                    'rgba(189, 248, 255, 0.7)'
                ],
                borderColor: [
                    'rgb(15, 26, 86)',
                    'rgb(168, 139, 222)',
                    'rgb(189, 248, 255)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Gr√°fico de pie (general vs no cumplido)
    const cumplidos = summary.items_cumplidos || 0;
    const noCumplidos = (summary.total_items || 0) - cumplidos;

    new Chart(areasPieCtx, {
        type: 'doughnut',
        data: {
            labels: ['Cumplidos', 'No Cumplidos'],
            datasets: [{
                data: [cumplidos, noCumplidos],
                backgroundColor: [
                    'rgba(168, 139, 222, 0.85)',
                    'rgba(255, 99, 132, 0.85)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });

    // Manejar env√≠o del formulario de filtros
    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(filterForm);
            const params = new URLSearchParams(formData);
            window.location.href = `/reports/dashboard?${params.toString()}`;
        });
    }

    // Exportar PDF respetando filtros (√°rea y periodo)
    const exportBtn = document.getElementById('exportPdf');
    if (exportBtn && filterForm) {
        exportBtn.addEventListener('click', () => {
            const formData = new FormData(filterForm);
            const area = formData.get('area') || '';
            const periodo = formData.get('periodo') || '30d';
            // Calcular desde/hasta en frontend
            const now = new Date();
            let days = 30;
            if (periodo === '7d') days = 7; else if (periodo === '90d') days = 90;
            const desde = new Date(now.getTime() - days*24*60*60*1000);
            const toISO = d => d.toISOString();
            const params = new URLSearchParams();
            if (area) params.set('area', area);
            params.set('desde', toISO(desde));
            params.set('hasta', toISO(now));
            window.location.href = `/reports/export/pdf?${params.toString()}`;
        });
    }

    // Bot√≥n de prueba de notificaci√≥n push
    const testPushBtn = document.getElementById('testPush');
    if (testPushBtn) {
        testPushBtn.addEventListener('click', async () => {
            try {
                // Asegurar que el usuario est√© suscrito antes de probar
                if (typeof registerPushIfAllowed === 'function') {
                    await registerPushIfAllowed(true); // pedir permiso si hace falta
                }

                const resp = await fetch('/notifications/test', { method: 'POST', credentials: 'same-origin' });
                if (!resp.ok) {
                    const j = await resp.json().catch(() => ({}));
                    alert('No se pudo enviar: ' + (j.detail || resp.statusText));
                    return;
                }
                const j = await resp.json();
                alert(`Notificaci√≥n enviada. Enviadas: ${j.sent}, errores: ${j.errors?.length || 0}`);
            } catch (e) {
                alert('Error al enviar notificaci√≥n: ' + e.message);
            }
        });
    }

    // Bot√≥n para probar notificaci√≥n local (usa showNotification directamente)
    const testLocalBtn = document.getElementById('testLocalNotif');
    if (testLocalBtn) {
        testLocalBtn.addEventListener('click', async () => {
            try {
                if (!('Notification' in window)) { alert('Este navegador no soporta notificaciones'); return; }
                if (Notification.permission !== 'granted') {
                    const p = await Notification.requestPermission();
                    if (p !== 'granted') { alert('Permite las notificaciones para probar'); return; }
                }
                // La scope del SW es /static/, as√≠ que p√≠dele espec√≠ficamente ese registro
                let reg = await navigator.serviceWorker.getRegistration(); // registro del alcance actual
                if (!reg) {
                    // Fallback: intentar por ruta espec√≠fica o esperar a que est√© listo
                    reg = await navigator.serviceWorker.getRegistration('/static/').catch(() => null) ||
                          await navigator.serviceWorker.ready.catch(() => null);
                }
                if (!reg) {
                    // √öltimo intento de registro
                    reg = await navigator.serviceWorker.register('/static/sw.js').catch(() => null);
                }
                if (!reg) { alert('Service Worker no registrado'); return; }
                await reg.showNotification('MedCheck (local)', {
                    body: 'Prueba local de notificaci√≥n (sin push) ‚Äî si ves esto, el sistema de notificaciones del SO est√° activo.',
                    icon: '/static/img/logo-192.png',
                    badge: '/static/img/logo-192.png',
                    requireInteraction: true,
                    data: { url: '/reports/dashboard' },
                    vibrate: [120, 60, 120]
                });
                alert('Notificaci√≥n enviada al sistema. Si no ves el aviso, revisa permisos del sitio y el Centro de notificaciones de Windows.');
            } catch (e) {
                alert('No se pudo mostrar la notificaci√≥n local: ' + e.message);
            }
        });
    }

    // Programar recordatorio r√°pido
    const scheduleBtn = document.getElementById('scheduleQuick');
    if (scheduleBtn) {
        scheduleBtn.addEventListener('click', async () => {
            try {
                const minutes = parseInt(document.getElementById('quickMinutes')?.value || '1', 10) || 1;
                // Asegurar permiso y suscripci√≥n
                if (typeof registerPushIfAllowed === 'function') {
                    await registerPushIfAllowed(true);
                }
                const res = await fetch('/reminders/quick', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ minutes, title: 'MedCheck', body: '‚è∞ Recordatorio programado' })
                });
                if (!res.ok) {
                    const j = await res.json().catch(() => ({}));
                    alert('No se pudo programar: ' + (j.detail || res.statusText));
                    return;
                }
                const j = await res.json();
                alert('Recordatorio programado para: ' + (j.scheduled_at || 'pronto'));
            } catch (e) {
                alert('Error al programar: ' + e.message);
            }
        });
    }

    // ===== CARGAR RECOMENDACIONES Y ACTIVAR VOZ =====
    async function loadRecommendations() {
        const filterForm = document.getElementById('filterForm');
        if (!filterForm) return;

        const formData = new FormData(filterForm);
        const periodo = formData.get('periodo') || '7d';
        const area = formData.get('area') || '';

        const container = document.getElementById('recommendationsContainer');

        try {
            const res = await fetch(`/reports/recommendations?periodo=${periodo}&area=${area}`);
            if (!res.ok) throw new Error('Error al cargar recomendaciones');

            const data = await res.json();
            renderRecommendations(data.recomendaciones || []);

            // A√±adir aviso si la voz no est√° habilitada
            checkVoiceAvailabilityForPanel();
        } catch (error) {
            console.error('Error loading recommendations:', error);
            container.innerHTML = `
                <div class="alert alert-warning p-2">
                    <i class="fas fa-exclamation-triangle"></i>
                    <small>No se pudieron cargar las recomendaciones</small>
                </div>
            `;
        }
    }

    async function checkVoiceAvailabilityForPanel() {
        try {
            const res = await fetch('/reports/voice-status');
            const data = await res.json();
            if (!data.enabled) {
                const container = document.getElementById('recommendationsContainer');
                const voiceNotice = `
                    <div class="card recommendation-card info p-3 mb-2">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-info-circle me-2 mt-1" style="font-size: 1.2rem;"></i>
                            <div class="flex-grow-1">
                                <strong class="d-block mb-1">Activar Resumen por Voz</strong>
                                <small class="text-muted">Para escuchar el resumen del reporte en audio, configura <code>ELEVENLABS_API_KEY</code> en Render > Environment y redepliega el servicio.</small>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += voiceNotice;
            }
        } catch (error) {
            // Silenciar error si el endpoint no est√° disponible
        }
    }

    function renderRecommendations(recommendations) {
        const container = document.getElementById('recommendationsContainer');

        if (recommendations.length === 0) {
            container.innerHTML = `
                <div class="alert alert-success p-3">
                    <i class="fas fa-check-circle mb-2"></i>
                    <p class="mb-0"><strong>¬°Excelente trabajo!</strong></p>
                    <small>No hay recomendaciones cr√≠ticas en este momento.</small>
                </div>
            `;
            return;
        }

        container.innerHTML = recommendations.map(rec => `
            <div class="card recommendation-card ${rec.tipo} p-3 mb-2">
                <div class="d-flex align-items-start">
                    <i class="fas ${rec.icono} me-2 mt-1" style="font-size: 1.2rem;"></i>
                    <div class="flex-grow-1">
                        <strong class="d-block mb-1">${rec.titulo}</strong>
                        <small class="text-muted">${rec.descripcion}</small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Activar bot√≥n de voz
    const voiceBtn = document.getElementById('voiceBtn');
    let voiceAvailable = false;

    // Verificar disponibilidad de clave en el servidor
    fetch('/reports/voice-status').then(r => r.json()).then(j => {
        voiceAvailable = !!(j && j.enabled);
        if (!voiceAvailable) {
            voiceBtn.title = 'Configura ELEVENLABS_API_KEY en Render > Environment para habilitar voz';
        }
    }).catch(() => {
        // Si el endpoint no existe, dejamos el comportamiento por defecto
    });

    if (voiceBtn) {
        voiceBtn.addEventListener('click', async function() {
            if (!voiceAvailable) {
                alert('Para habilitar la voz, configura ELEVENLABS_API_KEY en Render > Environment y redepliega.');
                return;
            }
            const filterForm = document.getElementById('filterForm');
            if (!filterForm) return;

            const formData = new FormData(filterForm);
            const periodo = formData.get('periodo') || '7d';
            const area = formData.get('area') || '';

            const icon = voiceBtn.querySelector('i');
            const originalClass = icon.className;

            try {
                icon.className = 'fas fa-spinner fa-spin';
                voiceBtn.disabled = true;

                const audio = new Audio(`/reports/voice-summary?periodo=${periodo}&area=${area}`);

                audio.onloadstart = () => {
                    icon.className = 'fas fa-volume-up';
                    voiceBtn.classList.add('playing');
                };

                audio.onended = () => {
                    icon.className = originalClass;
                    voiceBtn.classList.remove('playing');
                    voiceBtn.disabled = false;
                };

                audio.onerror = () => {
                    throw new Error('Error al reproducir audio');
                };

                await audio.play();

            } catch (error) {
                console.error('Voice error:', error);
                icon.className = originalClass;
                voiceBtn.classList.remove('playing');
                voiceBtn.disabled = false;

                alert('‚ö†Ô∏è Servicio de voz no disponible.\n\nAseg√∫rate de que ELEVENLABS_API_KEY est√© configurado en Render > Environment y que tu clave tenga el permiso "text_to_speech".');
            }
        });
    }

    // Mostrar banner para habilitar notificaciones si hace falta
    try {
        const container = document.querySelector('.card .card-body') || document.body;
        if ('Notification' in window && Notification.permission !== 'granted') {
            const banner = document.createElement('div');
            banner.className = 'alert alert-info d-flex justify-content-between align-items-center';
            banner.style.marginTop = '10px';
            banner.innerHTML = `
                <div>
                    <strong>Notificaciones desactivadas</strong>
                    <div><small>Permite notificaciones para recibir recordatorios.</small></div>
                </div>
                <button id="enableNotifsBtn" class="btn btn-sm btn-primary">Activar</button>
            `;
            container.prepend(banner);
            const btn = banner.querySelector('#enableNotifsBtn');
            btn.addEventListener('click', async () => {
                const res = await Notification.requestPermission();
                if (res === 'granted' && typeof registerPushIfAllowed === 'function') {
                    await registerPushIfAllowed(true);
                    banner.remove();
                    alert('Listo: Notificaciones activadas. Puedes probar con la campana verde o la campana tachada.');
                } else if (res === 'denied') {
                    alert('El navegador bloque√≥ las notificaciones. Cambia el permiso del sitio a "Permitir".');
                }
            });
        }
    } catch (e) { /* noop */ }

    // Cargar recomendaciones al inicio
    loadRecommendations();

    // ===== MATRIZ DE RIESGOS INTERACTIVA =====

    // Definici√≥n de riesgos por categor√≠a
    const riskDatabase = {
        // Riesgos cr√≠ticos (20-25)
        '25': {
            title: 'Riesgo Catastr√≥fico - Probabilidad Muy Alta',
            description: 'Error de medicaci√≥n fatal o con consecuencias permanentes graves',
            examples: ['Administraci√≥n de dosis letal sin verificaci√≥n', 'Confusi√≥n de pacientes en cirug√≠a'],
            action: 'üö® DETENER OPERACI√ìN INMEDIATA - Revisar todo el protocolo - Implementar doble verificaci√≥n obligatoria',
            priority: 'CR√çTICO'
        },
        '20-4': {
            title: 'Riesgo Muy Alto - Impacto Importante',
            description: 'Evento adverso grave probable con da√±o significativo',
            examples: ['Medicamento incorrecto en paciente cr√≠tico', 'Falta de verificaci√≥n de alergias'],
            action: '‚ö†Ô∏è Acci√≥n inmediata - Capacitaci√≥n urgente del personal - Implementar checklist obligatorio',
            priority: 'ALTO'
        },
        '20-5': {
            title: 'Riesgo Extremo - M√∫ltiples Fallos',
            description: 'Combinaci√≥n de fallos que pueden causar da√±o grave',
            examples: ['Falta de 3+ correctos simult√°neamente'],
            action: 'üî¥ Intervenci√≥n de emergencia - Auditor√≠a completa - Suspensi√≥n temporal hasta correcci√≥n',
            priority: 'CR√çTICO'
        },
        // Riesgos altos (15-16)
        '15': {
            title: 'Riesgo Alto - Evento Adverso Probable',
            description: 'Alta probabilidad de error con impacto moderado-alto',
            examples: ['Verificaci√≥n incompleta de dosis', 'Documentaci√≥n inadecuada'],
            action: '‚ö° Plan de acci√≥n en 24-48h - Reforzar capacitaci√≥n - Aumentar supervisi√≥n',
            priority: 'ALTO'
        },
        '16': {
            title: 'Riesgo Alto - Impacto Severo',
            description: 'Evento poco frecuente pero con consecuencias graves',
            examples: ['Fallo de equipo m√©dico cr√≠tico', 'Error en prescripci√≥n compleja'],
            action: 'üìã Protocolo de emergencia - Backup de sistemas - Plan de contingencia',
            priority: 'ALTO'
        },
        // Riesgos medios (8-12)
        '12-3': {
            title: 'Riesgo Medio - Posible Moderado',
            description: 'Errores ocasionales con impacto moderado',
            examples: ['Retrasos en administraci√≥n', 'Documentaci√≥n incompleta'],
            action: 'üìä Monitoreo mensual - Recordatorios peri√≥dicos - Mejora de procesos',
            priority: 'MEDIO'
        },
        '12-4': {
            title: 'Riesgo Medio - Probable Moderado',
            description: 'Errores frecuentes de impacto medio',
            examples: ['Omisi√≥n de educaci√≥n al paciente', 'Verificaci√≥n parcial'],
            action: 'üîç Revisi√≥n semanal - Capacitaci√≥n espec√≠fica - Ajuste de procedimientos',
            priority: 'MEDIO'
        },
        '10': {
            title: 'Riesgo Medio - Tolerable',
            description: 'Errores menores pero frecuentes',
            examples: ['Registro tard√≠o', 'Comunicaci√≥n deficiente'],
            action: 'üìù Plan de mitigaci√≥n - Mejora continua - Feedback regular',
            priority: 'MEDIO'
        },
        '8-4': {
            title: 'Riesgo Medio - Poco Probable Importante',
            description: 'Evento raro pero de impacto notable',
            examples: ['Falla de sistema inform√°tico', 'Interrupci√≥n de servicio'],
            action: 'üíæ Plan de respaldo - Procedimientos alternativos - Mantenci√≥n preventiva',
            priority: 'MEDIO'
        },
        '9': {
            title: 'Riesgo Medio - Eventos Ocasionales',
            description: 'Fallos espor√°dicos con impacto moderado',
            examples: ['Falla el√©ctrica durante horas pico'],
            action: '‚ö° Sistema de respaldo - Generador de emergencia - Protocolos manual/digital',
            priority: 'MEDIO'
        },
        // Riesgos bajos (1-6)
        'default': {
            title: 'Riesgo Bajo - Monitoreo Rutinario',
            description: 'Errores menores poco probables',
            examples: ['Retrasos m√≠nimos', 'Errores de formato en registros'],
            action: '‚úÖ Continuar monitoreo est√°ndar - Revisi√≥n trimestral',
            priority: 'BAJO'
        }
    };

    // Funci√≥n para obtener informaci√≥n del riesgo
    function getRiskInfo(score, prob, impact) {
        const key = score.toString();

        // Buscar coincidencia exacta
        if (riskDatabase[key]) return riskDatabase[key];

        // Buscar por rangos espec√≠ficos
        if (score >= 20 && prob === 4) return riskDatabase['20-4'];
        if (score >= 20 && prob === 5) return riskDatabase['20-5'];
        if (score === 12 && prob === 3) return riskDatabase['12-3'];
        if (score === 12 && prob === 4) return riskDatabase['12-4'];
        if (score === 8 && prob === 2) return riskDatabase['8-4'];

        // Por defecto seg√∫n el score
        if (score >= 20) return riskDatabase['25'];
        if (score >= 15) return riskDatabase['15'];
        if (score >= 8) return riskDatabase['10'];

        return riskDatabase['default'];
    }

    // Manejo de clicks en las celdas de la matriz
    document.querySelectorAll('.risk-cell').forEach(cell => {
        cell.addEventListener('click', function() {
            const prob = parseInt(this.dataset.prob);
            const impact = parseInt(this.dataset.impact);
            const score = parseInt(this.dataset.score);

            // Remover clase activa de todas las celdas
            document.querySelectorAll('.risk-cell').forEach(c => c.classList.remove('active'));

            // Agregar clase activa a la celda clickeada
            this.classList.add('active');

            // Obtener informaci√≥n del riesgo
            const riskInfo = getRiskInfo(score, prob, impact);

            // Actualizar panel de informaci√≥n
            const panel = document.getElementById('riskInfoPanel');
            const title = document.getElementById('riskTitle');
            const details = document.getElementById('riskDetails');

            const priorityColors = {
                'CR√çTICO': 'danger',
                'ALTO': 'warning',
                'MEDIO': 'info',
                'BAJO': 'success'
            };

            title.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${riskInfo.title}
                <span class="badge bg-${priorityColors[riskInfo.priority]} ms-2">${riskInfo.priority}</span>
            `;

            details.innerHTML = `
                <div class="mb-3">
                    <strong>Puntuaci√≥n de Riesgo:</strong> ${score}
                    <small class="text-muted">(Probabilidad: ${prob} √ó Impacto: ${impact})</small>
                </div>

                <div class="mb-3">
                    <strong>Descripci√≥n:</strong>
                    <p class="mb-2">${riskInfo.description}</p>
                </div>

                <div class="mb-3">
                    <strong>Ejemplos Identificados:</strong>
                    <ul class="mb-0">
                        ${riskInfo.examples.map(ex => `<li>${ex}</li>`).join('')}
                    </ul>
                </div>

                <div class="alert alert-${priorityColors[riskInfo.priority]} mb-0">
                    <strong><i class="fas fa-tasks me-2"></i>Acci√≥n Recomendada:</strong>
                    <p class="mb-0 mt-2">${riskInfo.action}</p>
                </div>
            `;

            panel.style.display = 'block';
            panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });
    });

    // Cambio entre vista de matriz y lista
    document.querySelectorAll('[data-view]').forEach(btn => {
        btn.addEventListener('click', function() {
            const view = this.dataset.view;

            // Actualizar botones activos
            document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            // Mostrar/ocultar vistas
            document.getElementById('matrixView').style.display = view === 'matrix' ? 'block' : 'none';
            document.getElementById('listView').style.display = view === 'list' ? 'block' : 'none';

            // Si es vista de lista, cargar los riesgos
            if (view === 'list') {
                loadRiskList();
            }
        });
    });

    // Cargar lista de riesgos
    function loadRiskList() {
        const tbody = document.getElementById('riskListBody');

        const risks = [
            { name: 'Verificaci√≥n incompleta de dosis', prob: 4, impact: 5, score: 20, level: 'CR√çTICO' },
            { name: 'Falta de verificaci√≥n de alergias', prob: 3, impact: 5, score: 15, level: 'ALTO' },
            { name: 'Documentaci√≥n incompleta', prob: 4, impact: 3, score: 12, level: 'MEDIO' },
            { name: 'Omisi√≥n educaci√≥n paciente', prob: 4, impact: 2, score: 8, level: 'MEDIO' },
            { name: 'Registro tard√≠o', prob: 3, impact: 2, score: 6, level: 'BAJO' },
            { name: 'Falla sistema inform√°tico', prob: 2, impact: 4, score: 8, level: 'MEDIO' }
        ];

        const levelColors = {
            'CR√çTICO': 'danger',
            'ALTO': 'warning',
            'MEDIO': 'info',
            'BAJO': 'success'
        };

        tbody.innerHTML = risks.map(risk => {
            const info = getRiskInfo(risk.score, risk.prob, risk.impact);
            return `
                <tr>
                    <td><strong>${risk.name}</strong></td>
                    <td><span class="badge bg-secondary">${risk.prob}</span></td>
                    <td><span class="badge bg-secondary">${risk.impact}</span></td>
                    <td>
                        <span class="badge bg-${levelColors[risk.level]}">${risk.level}</span>
                        <small class="text-muted d-block">${risk.score} pts</small>
                    </td>
                    <td><small>${info.action}</small></td>
                </tr>
            `;
        }).join('');
    }

    // Gr√°fico de distribuci√≥n de riesgos
    const riskCtx = document.getElementById('riskDistributionChart');
    if (riskCtx) {
        new Chart(riskCtx, {
            type: 'doughnut',
            data: {
                labels: ['Bajo', 'Medio', 'Alto', 'Cr√≠tico'],
                datasets: [{
                    data: [60, 25, 10, 5],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(253, 126, 20, 0.8)',
                        'rgba(220, 53, 69, 0.8)'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: false
                    }
                }
            }
        });
    }

    // Gr√°fico de distribuci√≥n por √°rea
    const areaCtx = document.getElementById('areaDistributionChart');
    if (areaCtx) {
        new Chart(areaCtx, {
            type: 'bar',
            data: {
                labels: ['UCI', 'Urgencias', 'Hospitalizaci√≥n', 'Cirug√≠a', 'Pediatr√≠a'],
                datasets: [{
                    label: 'Riesgos Cr√≠ticos',
                    data: [2, 1, 0, 1, 1],
                    backgroundColor: 'rgba(220, 53, 69, 0.8)'
                }, {
                    label: 'Riesgos Altos',
                    data: [3, 2, 1, 2, 1],
                    backgroundColor: 'rgba(253, 126, 20, 0.8)'
                }, {
                    label: 'Riesgos Medios',
                    data: [5, 6, 3, 4, 2],
                    backgroundColor: 'rgba(255, 193, 7, 0.8)'
                }, {
                    label: 'Riesgos Bajos',
                    data: [10, 12, 15, 8, 13],
                    backgroundColor: 'rgba(40, 167, 69, 0.8)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Cantidad de Riesgos'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: false
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
