{% extends "base.html" %}

{% block title %}Dashboard de Reportes{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2>Dashboard de Reportes</h2>
        
        <!-- Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    {% if current_user and current_user.role == "admin" %}
                    <div class="col-md-4">
                        <label class="form-label">Área</label>
                        <select class="form-select" name="area">
                            <option value="">Todas las áreas</option>
                            <option value="{{ area_filtrada }}" {% if area_filtrada %}selected{% endif %}>{{ area_filtrada }}</option>
                        </select>
                    </div>
                    {% endif %}
                    <div class="col-md-4">
                        <label class="form-label">Periodo</label>
                        <select class="form-select" name="periodo">
                            <option value="7d" {% if periodo == "7d" %}selected{% endif %}>Últimos 7 días</option>
                            <option value="30d" {% if periodo == "30d" %}selected{% endif %}>Últimos 30 días</option>
                            <option value="90d" {% if periodo == "90d" %}selected{% endif %}>Últimos 90 días</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary">Actualizar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Resumen -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total Items</h5>
                        <h2>{{ summary.total_items if summary else 0 }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card {% if summary and summary.porcentaje_cumplimiento >= 90 %}bg-success{% elif summary and summary.porcentaje_cumplimiento >= 70 %}bg-warning{% else %}bg-danger{% endif %} text-white">
                    <div class="card-body">
                        <h5 class="card-title">Cumplimiento</h5>
                        <h2>{{ summary.porcentaje_cumplimiento if summary else 0 }}%</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Items Cumplidos</h5>
                        <h2>{{ summary.items_cumplidos if summary else 0 }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-secondary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Periodo</h5>
                        <h2>{{ periodo }}</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Tendencia de Cumplimiento</h5>
                        <canvas id="cumplimientoChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Cumplimiento por Área</h5>
                        <canvas id="areasPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de Anomalías -->
{% if current_user and current_user.role in ["admin", "supervisor"] %}
<!-- Comparación de Turnos -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Comparación de Turnos</h5>
                <canvas id="turnosChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Items Críticos -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Items Críticos que Requieren Atención</h5>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Área</th>
                                <th>Etapa</th>
                                <th>Item</th>
                                <th>Cumplimiento</th>
                                <th>Última Revisión</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="criticalItemsTable">
                            <!-- Se llenará con JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Anomalías -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Alertas de Anomalías</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Área</th>
                                <th>Etapa</th>
                                <th>Cumplimiento Actual</th>
                                <th>Promedio Histórico</th>
                                <th>Variación</th>
                            </tr>
                        </thead>
                        <tbody id="anomaliasTableBody">
                            <!-- Se llena dinámicamente con JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    // Inicializar gráficos
    const cumplimientoCtx = document.getElementById('cumplimientoChart').getContext('2d');
    const areasPieCtx = document.getElementById('areasPieChart').getContext('2d');
    const turnosCtx = document.getElementById('turnosChart')?.getContext('2d');
    
    // Cargar datos
    const area = document.querySelector('select[name="area"]')?.value || '';
    const periodo = document.querySelector('select[name="periodo"]').value;
    
    // Cargar tendencias
    const trendsResponse = await fetch(`/reports/compliance-trends?area=${area}&periodo=${periodo}`);
    const trendsData = await trendsResponse.json();
    const trendLabels = trendsData.labels || ["Lun", "Mar", "Mié", "Jue", "Vie"];
    const trendValues = trendsData.data || [0, 0, 0, 0, 0];
    
    // Gráfico de tendencia
    new Chart(cumplimientoCtx, {
        type: 'line',
        data: {
            labels: trendLabels,
            datasets: [{
                label: '% Cumplimiento',
                data: trendValues,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    // Cargar datos de áreas
    const summaryResponse = await fetch(`/reports/summary?area=${area}`);
    const summaryData = await summaryResponse.json();
    
    // Gráfico de áreas
    new Chart(areasPieCtx, {
        type: 'pie',
        data: {
            labels: ['UCI', 'Emergencia', 'Medicina', 'Cirugía'],
            datasets: [{
                data: [95, 88, 85, 92],
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)'
                ]
            }]
        }
    });
    
    // Gráfico de comparación de turnos
    if (turnosCtx) {
    const turnosResponse = await fetch(`/reports/turnos-comparison?area=${area}&periodo=${periodo}`);
    const turnosData = await turnosResponse.json();
    const turnosLabels = turnosData.labels || ["Mañana", "Tarde", "Noche"];
    const turnosValues = turnosData.data || [0, 0, 0];
        
        new Chart(turnosCtx, {
            type: 'bar',
            data: {
                labels: turnosLabels,
                datasets: [{
                    label: '% Cumplimiento por Turno',
                    data: turnosValues,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(54, 162, 235, 0.5)',
                        'rgba(255, 205, 86, 0.5)'
                    ],
                    borderColor: [
                        'rgb(255, 99, 132)',
                        'rgb(54, 162, 235)',
                        'rgb(255, 205, 86)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }

    // Cargar items críticos
    try {
        const criticalResponse = await fetch(`/reports/critical-items?area=${area}&periodo=${periodo}`);
        if (criticalResponse.ok) {
            const criticalData = await criticalResponse.json();
            const tbody = document.getElementById('criticalItemsTable');
            tbody.innerHTML = ''; // Limpiar tabla
            
            criticalData.forEach(item => {
                const row = document.createElement('tr');
                const statusClass = item.cumplimiento < 70 ? 'text-danger' : 
                                  item.cumplimiento < 90 ? 'text-warning' : 'text-success';
                row.innerHTML = `
                    <td>${item.area}</td>
                    <td>${item.etapa}</td>
                    <td>${item.item}</td>
                    <td class="${statusClass}">${item.cumplimiento}%</td>
                    <td>${new Date(item.ultima_revision).toLocaleDateString()}</td>
                    <td><span class="badge bg-${statusClass.split('-')[1]}">${
                        item.cumplimiento < 70 ? 'Crítico' : 
                        item.cumplimiento < 90 ? 'Atención' : 'Normal'
                    }</span></td>
                `;
                tbody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error al cargar items críticos:', error);
    }

    // Cargar anomalías
    try {
        const response = await fetch('/reports/anomalies');
        if (response.ok) {
            const data = await response.json();
            const tbody = document.getElementById('anomaliasTableBody');
            tbody.innerHTML = ''; // Limpiar tabla
            
            data.anomalies.forEach(anomaly => {
                const row = document.createElement('tr');
                const variacion = (anomaly.promedio_historico - anomaly.cumplimiento_actual) * 100;
                const variacionClass = variacion > 20 ? 'text-danger' : 
                                     variacion > 10 ? 'text-warning' : 'text-success';
                
                row.innerHTML = `
                    <td>${anomaly.area}</td>
                    <td>${anomaly.protocolo_etapa}</td>
                    <td class="${variacionClass}">${(anomaly.cumplimiento_actual * 100).toFixed(1)}%</td>
                    <td>${(anomaly.promedio_historico * 100).toFixed(1)}%</td>
                    <td class="${variacionClass}">-${variacion.toFixed(1)}%</td>
                    <td>${(anomaly.cumplimiento_actual * 100).toFixed(1)}%</td>
                    <td>${(anomaly.promedio_historico * 100).toFixed(1)}%</td>
                    <td class="text-danger">-${variacion.toFixed(1)}%</td>
                `;
                tbody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error cargando anomalías:', error);
    }
});
</script>
{% endblock %}